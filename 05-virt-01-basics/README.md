
# Домашнее задание к занятию "5.1. Введение в виртуализацию. Типы и функции гипервизоров. Обзор рынка вендоров и областей применения."


## Как сдавать задания

Обязательными к выполнению являются задачи без указания звездочки. Их выполнение необходимо для получения зачета и диплома о профессиональной переподготовке.

Задачи со звездочкой (*) являются дополнительными задачами и/или задачами повышенной сложности. Они не являются обязательными к выполнению, но помогут вам глубже понять тему.

Домашнее задание выполните в файле readme.md в github репозитории. В личном кабинете отправьте на проверку ссылку на .md-файл в вашем репозитории.

Любые вопросы по решению задач задавайте в чате учебной группы.

---

## Задача 1

Опишите кратко, как вы поняли: в чем основное отличие полной (аппаратной) виртуализации, паравиртуализации и виртуализации на основе ОС.

Ответ:
- Аппаратная виртуализация -  Гипервизор (менеджер виртуальных машин), напрямую работает с аппаратными ресурсами хоста. Это позволяет снизить накладные расходы от прослойки (гипервизора) и при этом получить достаточно плотную работу с "железом", пробрасывая не только порты, но даже отдельные устройства внутрь виртуальных машин. Для пользователя гипервизор выглядит, как отдельная операционная система, устанавливаетс на голое железо с загрузочного носителя.
- Паравиртуализация - Гипервизор (менеджер виртуальных машин), с аппаратными ресурсами хоста работает через операционную систему, на которой запущен, требует изменения ядра гостевой ОС (или манипуляции с запуском его через qemu, как это было с запуском Windows на гипервизоре XEN ver<3) это добавляет накладные расходы на всех операциях виртуальных машин и надежность решения складывается из надежности самого гипервизора и надежности ОС. Для пользователя выглядит как программное обеспечение, устанавливается на уже установленную и настроенную ОС.
- Виртуализация на основе ОС - представляет пользователю изолированные контейнеры, которые используют ядро хостовой ОС, удобно использовать, когда решаемые задачи не требуют тесной работы с аппаратной частью, а требуется создавать много похожих (одинаковых) сервисов. Еще, когда требуется много вариантов разных программ, настроек, чтобы выбрать лучший, а остальные убрать - такое требуется, например, при разработке. 

Доработка:

В чём разница при работе с ядром гостевой ОС для полной и паравиртуализации? 

- Паравиртуализация - это виртуализация, при которой гостевая операционная система (виртуализируемая) осознает, что она гостевая, и, соответственно, имеет драйверы, которые вместо выдачи аппаратных команд просто выдают команды непосредственно операционной системе хоста. Это также включает в себя управление памятью и потоками, которые обычно требуют недоступных привилегированных инструкций в процессоре. Чтобы гостевая ОС могла это осуществлять, ее ядро должно быть модифицировано.

- Полная виртуализация - это виртуализация, при которой гостевая операционная система не знает, что она находится в виртуализированной среде, и поэтому операционная система хоста виртуализирует аппаратное обеспечение, чтобы гость мог выдавать команды тому, что он считает реальным оборудованием, но на самом деле это просто имитированные аппаратные устройства, созданные хостом. Такие условия для гостевой ВМ могут быть созданы программным гипервизором, но сейчас (примерно с 2006 г. для процессоров intel) для полной аппаратной виртуализации архитектура микропроцессора содержит специальные инструкции, помогающие виртуализации аппаратного обеспечения. Эти инструкции могут позволить настроить виртуальный контекст таким образом, чтобы гость мог выполнять привилегированные инструкции непосредственно на процессоре, не влияя на хост. Такой набор функций часто называют гипервизором. Если указанных инструкций не существует, полная виртуализация все еще возможна, однако это должно быть сделано с помощью программных методов, таких какДинамическая перекомпиляция, при которой хост перекомпилирует на лету привилегированные инструкции в гостевой системе, чтобы иметь возможность работать на хосте непривилегированным способом. 

Итог: При паравиртуализации гостевая ОС вместо выдачи аппаратных команд просто выдает команды непосредственно операционной системе хоста, это требует модификации ядра гостевой ОС, а при аппаратной виртуализации, аппаратные команды от гостевой ОС обрабатываются виртуализированными устройствами, это не требует модификации ядра гостевой ОС. 

## Задача 2

Выберите один из вариантов использования организации физических серверов, в зависимости от условий использования.

Организация серверов:
- физические сервера,
- паравиртуализация,
- виртуализация уровня ОС.

Условия использования:
- Высоконагруженная база данных, чувствительная к отказу.
- Различные web-приложения.
- Windows системы для использования бухгалтерским отделом.
- Системы, выполняющие высокопроизводительные расчеты на GPU.

Опишите, почему вы выбрали к каждому целевому использованию такую организацию.

Ответ:

#### 1. Высоконагруженная база данных, чувствительная к отказу.
В данной задаче - физические сервера, т.к. паравиртуализация добавляет накладные расходы на процессорные, дисковые операции и т.д. Что не позволит получить максимальную производительность на данном железе. За счет кластеризации виртуальных серверов (паравиртуализация) можно повысить отказоустойчивость, но сама программа - гипервизор, тоже имеет определенную надежность. Поэтому окончательно решить данный вопрос можно исходя из конкретной ситуации, выставив баланс между скоростью работы и надежностью системы. Для большинства подобных условий использования, подошла бы аппаратная виртуализация, но ее нет в условиях задачи.  

#### 2. Различные web-приложения.
виртуализация уровня ОС в данном случае повысит эффективность использования ресурсов, позволит производить масштабирование, в зависимости от нагрузки на сервис, а также максимально приблизить среду разработки и продакшена (контейнеры могут быть одинаковыми, отличаясь параметрами запуска)  

#### 3. Windows системы для использования бухгалтерским отделом.
В случае небольшого количества серверов, с постоянной нагрузкой (возможно высокой), без прогнозов на расширение - физические сервера.
Для большого количества серверов и при повышенных требованиях к надежности, имеет смысл использовать паравиртуализацию, т.к. это позволит балансировать нагрузку, получить возможность расширения ресурсов. Высокая надежность будет достигнута за счет кластеризации виртуальной инфраструктуры (миграция между узлами кластера) и резервирования ресурсов, виртуальных машин.  

#### 4. Системы, выполняющие высокопроизводительные расчеты на GPU.
Для данного кейса требуется использовать физические сервера. Это позволит получить максимальную производительность и надежность избавившись от прослойки в виде гипервизора между ПО и аппаратными ресурсами, позволит наиболее "плотно" с ними работать.



## Задача 3

Выберите подходящую систему управления виртуализацией для предложенного сценария. Детально опишите ваш выбор.

Сценарии:

1. 100 виртуальных машин на базе Linux и Windows, общие задачи, нет особых требований. Преимущественно Windows based инфраструктура, требуется реализация программных балансировщиков нагрузки, репликации данных и автоматизированного механизма создания резервных копий.
2. Требуется наиболее производительное бесплатное open source решение для виртуализации небольшой (20-30 серверов) инфраструктуры на базе Linux и Windows виртуальных машин.
3. Необходимо бесплатное, максимально совместимое и производительное решение для виртуализации Windows инфраструктуры.
4. Необходимо рабочее окружение для тестирования программного продукта на нескольких дистрибутивах Linux.

Ответ:
#### 1. В данной задаче требуется, по сути, удобная система управления виртуальной инфраструктурой, с продвинутой системой балансировки, репликации данных и резервирования, поэтому можно применить аппаратную виртуализацию HYPER-V от Microsoft или на основе KVM, например PROXMOX (KVM часть), одним из критериев выбора можно принять наличие в штате специалистов по конкретной системе виртуализации.    

#### 2. В качестве бесплатного opensource решения, позволяющего виртуализировать и Windows, и Linux, можно использовать виртуализацию на основе KVM, например PROXMOХ. 

#### 3. В данном случае можно использовать HYPER-V, в редакции core он бесплатен, производителен и максимально совместим с Windows-гостями.

#### 4. Если программный продукт работает с железом, требует проброса аппаратных портов или устройств, имеет смысл применить паравиртуализацию, VirtualBox или VmWare Player. Если речь идет, например о веб приложении, удобнее будет использовать контейнеризацию, например docker.



## Задача 4

Опишите возможные проблемы и недостатки гетерогенной среды виртуализации (использования нескольких систем управления виртуализацией одновременно) и что необходимо сделать для минимизации этих рисков и проблем. Если бы у вас был выбор, то создавали бы вы гетерогенную среду или нет? Мотивируйте ваш ответ примерами.

Ответ: 
- Как и в любой гетерогенной среде будут возникать вопросы совместимости между разными системами, минимизировать такие риски можно с помощью тестирования, отработки необходимых кейсов использования систем. Аппаратные ресурсы будут "фрагментированы", разными системами управления, чтобы минимизировать влияние проблем такого характера, необходимо тщательно планировать размещение (проработка сценариев размещения) виртуальных машин - на каких гипервизорах, под какими системами управления могут быть запущены (допустимо размещать) требуемые виртуальные машины. В вышеобозначенных рисках не обойтись без программ - конверторов, например для смены типа виртуальной машины, сами машины должны быть подготовлены к конвертированию (содержать в себе необходимые драйверы для разного "виртуального железа"). Также требуется или расширять штат специалистов, для каждого вендора гетерогенной системы (тоже некоторое фрагментирование на одном вендоре специалисты не загружены, на другом перегружены) или это должны быть более продвинутые специалисты, способные работать с разными вендорами.   

- Часто, выбор предоставляют обстоятельства, редко бывает безграничное финансирование, поэтому бывают ситуации, когда некоторая часть виртуалок запущена на гипервизоре одного вендора, т.к. он обеспечивает работу определенных функций, например проброс портов и устройств в виртуалку, с вендором подписан договор на обслуживание с определенным SLA, закуплены лицензии на ПО, а другим виртуалкам достаточно только процессора и памяти, которые может обеспечить бесплатный KVM и доработки, исправление возможных проблем допустимо производить своими силами. Также можно рассмотреть использование контейнеризации (docker, lxc), на виртуальной машине, внутри клаcтера vmware, proxmox (KVM) или XEN. Такой подход можно применить, например, при развертывании фреймворка для тестирования сайтов selenium, с применением docke (selenoid, selenoid-ui) или при разработке, например, веб-продуктов.  